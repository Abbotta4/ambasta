From e221b4ef92f6e861c08f7d1983b3f79f48b7a4e4 Mon Sep 17 00:00:00 2001
From: Amit Prakash Ambasta <amit.prakash.ambasta@gmail.com>
Date: Fri, 18 Jun 2021 12:26:05 +0530
Subject: [PATCH] mallinfo2 changes

---
 src/tbbmalloc_proxy/def/lin32-proxy.def | 2 +-
 src/tbbmalloc_proxy/def/lin64-proxy.def | 2 +-
 src/tbbmalloc_proxy/proxy.cpp           | 6 +++---
 test/tbbmalloc/test_malloc_overload.cpp | 2 +-
 4 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/src/tbbmalloc_proxy/def/lin32-proxy.def b/src/tbbmalloc_proxy/def/lin32-proxy.def
index d044325..122fc89 100644
--- a/src/tbbmalloc_proxy/def/lin32-proxy.def
+++ b/src/tbbmalloc_proxy/def/lin32-proxy.def
@@ -25,7 +25,7 @@ memalign;
 aligned_alloc;
 valloc;
 pvalloc;
-mallinfo;
+mallinfo2;
 mallopt;
 malloc_usable_size;
 __libc_malloc;
diff --git a/src/tbbmalloc_proxy/def/lin64-proxy.def b/src/tbbmalloc_proxy/def/lin64-proxy.def
index f0764d4..b826c4a 100644
--- a/src/tbbmalloc_proxy/def/lin64-proxy.def
+++ b/src/tbbmalloc_proxy/def/lin64-proxy.def
@@ -25,7 +25,7 @@ memalign;
 aligned_alloc;
 valloc;
 pvalloc;
-mallinfo;
+mallinfo2;
 mallopt;
 malloc_usable_size;
 __libc_malloc;
diff --git a/src/tbbmalloc_proxy/proxy.cpp b/src/tbbmalloc_proxy/proxy.cpp
index f9942bf..3f0ebf0 100644
--- a/src/tbbmalloc_proxy/proxy.cpp
+++ b/src/tbbmalloc_proxy/proxy.cpp
@@ -253,10 +253,10 @@ int mallopt(int /*param*/, int /*value*/) __THROW
     return 1;
 }
 
-struct mallinfo mallinfo() __THROW
+struct mallinfo2 mallinfo2() __THROW
 {
-    struct mallinfo m;
-    memset(&m, 0, sizeof(struct mallinfo));
+    struct mallinfo2 m;
+    memset(&m, 0, sizeof(struct mallinfo2));
 
     return m;
 }
diff --git a/test/tbbmalloc/test_malloc_overload.cpp b/test/tbbmalloc/test_malloc_overload.cpp
index 12081d7..0f7ba6c 100644
--- a/test/tbbmalloc/test_malloc_overload.cpp
+++ b/test/tbbmalloc/test_malloc_overload.cpp
@@ -434,7 +434,7 @@ TEST_CASE("Main set of tests") {
     CheckMemalignFuncOverload(aligned_alloc, free);
 #endif
 
-    struct mallinfo info = mallinfo();
+    struct mallinfo2 info = mallinfo2();
     // right now mallinfo initialized by zero
     REQUIRE((!info.arena && !info.ordblks && !info.smblks && !info.hblks
            && !info.hblkhd && !info.usmblks && !info.fsmblks
-- 
2.32.0

